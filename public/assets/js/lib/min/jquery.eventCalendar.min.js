$.fn.eventCalendar=function(j){function h(m,l){return m.date.toLowerCase()>l.date.toLowerCase()?1:-1}function d(y,v,s){var n=$("<div class='eventsCalendar-slider'></div>"),m=$("<div class='eventsCalendar-monthWrap'></div>"),p=$("<div class='eventsCalendar-currentTitle'><a href='#' class='monthTitle'></a></div>"),x=$("<a href='#' class='arrow prev'><span>"+a.txt_prev+"</span></a><a href='#' class='arrow next'><span>"+a.txt_next+"</span></a>");if($eventsCalendarDaysList=$("<ul class='eventsCalendar-daysList'></ul>"),date=new Date,b.wrap.find(".eventsCalendar-slider").size()?b.wrap.find(".eventsCalendar-slider").append(m):(b.wrap.prepend(n),n.append(m)),b.wrap.find(".eventsCalendar-monthWrap.currentMonth").removeClass("currentMonth").addClass("oldMonth"),m.addClass("currentMonth").append(p,$eventsCalendarDaysList),"current"===y){day=date.getDate(),n.append(x)}else{date=new Date(b.wrap.attr("data-current-year"),b.wrap.attr("data-current-month"),1,0,0,0),day=0,moveOfMonth=1,"prev"===y&&(moveOfMonth=-1),date.setMonth(date.getMonth()+moveOfMonth);var l=new Date;date.getMonth()===l.getMonth()&&(day=l.getDate())}var v=date.getFullYear(),q=(new Date).getFullYear(),s=date.getMonth();"current"!=y&&g(a.eventsLimit,v,s,!1,y),b.wrap.attr("data-current-month",s).attr("data-current-year",v),p.find(".monthTitle").html(a.monthNames[s]+" "+v);var u=32-new Date(v,s,32).getDate(),t=[];if(a.showDayAsWeeks){if($eventsCalendarDaysList.addClass("showAsWeek"),a.showDayNameInCalendar){$eventsCalendarDaysList.addClass("showDayNames");var o=0;for(a.startWeekOnMonday&&(o=1);7>o;o++){t.push('<li class="eventsCalendar-day-header">'+a.dayNamesShort[o]+"</li>"),6===o&&a.startWeekOnMonday&&t.push('<li class="eventsCalendar-day-header">'+a.dayNamesShort[0]+"</li>")}}dt=new Date(v,s,1);var r=dt.getDay();for(a.startWeekOnMonday&&(r=dt.getDay()-1),0>r&&(r=6),o=r;o>0;o--){t.push('<li class="eventsCalendar-day empty"></li>')}}for(dayCount=1;u>=dayCount;dayCount++){var w="";day>0&&dayCount===day&&v===q&&(w="today"),t.push('<li id="dayList_'+dayCount+'" rel="'+dayCount+'" class="eventsCalendar-day '+w+'"><a href="#">'+dayCount+"</a></li>")}$eventsCalendarDaysList.append(t.join("")),n.css("height",m.height()+"px")}function i(o){var m,l=o.length,n=o.charAt(l-1);return m=2===l&&"1"===o.charAt(0)?"th":"1"===n?"st":"2"===n?"nd":"3"===n?"rd":"th",o+m}function g(l,n,p,m,o){var l=l||0,n=n||"",m=m||"";if("undefined"!=typeof p){var p=p}else{var p=""}b.wrap.find(".eventsCalendar-loading").fadeIn(),a.jsonData?(a.cacheJson=!0,b.eventsJson=a.jsonData,k(b.eventsJson,l,n,p,m,o)):a.cacheJson&&o?k(b.eventsJson,l,n,p,m,o):$.getJSON(a.eventsjson+"?limit="+l+"&year="+n+"&month="+p+"&day="+m,function(q){b.eventsJson=q,k(b.eventsJson,l,n,p,m,o)}).error(function(){e("error getting json: ")}),m>""&&(b.wrap.find(".current").removeClass("current"),b.wrap.find("#dayList_"+m).addClass("current"))}function k(o,l,n,q,m,p){directionLeftMove="-="+b.directionLeftMove,eventContentHeight="auto",subtitle=b.wrap.find(".eventsCalendar-list-wrap .eventsCalendar-subtitle"),p?(""!=m?subtitle.html(a.txt_SpecificEvents_prev+a.monthNames[q]+" "+i(m)+" "+a.txt_SpecificEvents_after):subtitle.html(a.txt_SpecificEvents_prev+a.monthNames[q]+" "+a.txt_SpecificEvents_after),"prev"===p?directionLeftMove="+="+b.directionLeftMove:("day"===p||"month"===p)&&(directionLeftMove="+=0",eventContentHeight=0)):(subtitle.html(a.txt_NextEvents),eventContentHeight="auto",directionLeftMove="-=0"),b.wrap.find(".eventsCalendar-list").animate({opacity:a.moveOpacity,left:directionLeftMove,height:eventContentHeight},a.moveSpeed,function(){b.wrap.find(".eventsCalendar-list").css({left:0,height:"auto"}).hide();var s=[];if(o=$(o).sort(h),o.length){var u="";a.showDescription||(u="hidden");var t="_self";a.openEventInNewWindow&&(t="_target");var r=0;$.each(o,function(G,w){if("human"==a.jsonDateFormat){var F=w.date.split(" "),D=F[0].split("-"),C=F[1].split(":"),x=D[0],v=parseInt(D[1])-1,H=parseInt(D[2]),A=parseInt(v)+1,E=C[0],z=C[1],B=C[2],D=new Date(x,v,H,E,z,B)}else{var D=new Date(parseInt(w.date)),x=D.getFullYear(),v=D.getMonth(),H=D.getDate(),A=v+1,E=D.getHours(),z=D.getMinutes()}if(parseInt(z)<=9&&(z="0"+parseInt(z)),(0===l||l>r)&&!(q!==!1&&q!=v||""!=m&&m!=H||""!=n&&n!=x)){if(q===!1&&D<new Date){}else{if(eventStringDate=H+"/"+A+"/"+x,w.url){var y='<a href="'+w.url+'" target="'+t+'" class="eventTitle">'+w.title+"</a>"}else{var y='<span class="eventTitle">'+w.title+"</span>"}s.push('<li id="'+G+'" class="'+w.type+'"><time datetime="'+D+'"><em>'+eventStringDate+"</em><small>"+E+":"+z+"</small></time>"+y+'<p class="eventDesc '+u+'">'+w.description+"</p></li>"),r++}}x==b.wrap.attr("data-current-year")&&v==b.wrap.attr("data-current-month")&&b.wrap.find(".currentMonth .eventsCalendar-daysList #dayList_"+parseInt(H)).addClass("dayWithEvents")})}s.length||s.push('<li class="eventsCalendar-noEvents"><p>'+a.txt_noEvents+"</p></li>"),b.wrap.find(".eventsCalendar-loading").hide(),b.wrap.find(".eventsCalendar-list").html(s.join("")),b.wrap.find(".eventsCalendar-list").animate({opacity:1,height:"toggle"},a.moveSpeed)}),f()}function c(){b.wrap.find(".arrow").click(function(m){if(m.preventDefault(),$(this).hasClass("next")){d("next");var l="-="+b.directionLeftMove}else{d("prev");var l="+="+b.directionLeftMove}b.wrap.find(".eventsCalendar-monthWrap.oldMonth").animate({opacity:a.moveOpacity,left:l},a.moveSpeed,function(){b.wrap.find(".eventsCalendar-monthWrap.oldMonth").remove()})})}function e(l){b.wrap.find(".eventsCalendar-list-wrap").html("<span class='eventsCalendar-loading error'>"+l+" "+a.eventsjson+"</span>")}function f(){b.directionLeftMove=b.wrap.width(),b.wrap.find(".eventsCalendar-monthWrap").width(b.wrap.width()+"px"),b.wrap.find(".eventsCalendar-list-wrap").width(b.wrap.width()+"px")}var a=$.extend({},$.fn.eventCalendar.defaults,j),b={wrap:"",directionLeftMove:"300",eventsJson:{}};this.each(function(){b.wrap=$(this),b.wrap.addClass("eventCalendar-wrap").append("<div class='eventsCalendar-list-wrap'><p class='eventsCalendar-subtitle'></p><span class='eventsCalendar-loading'>loading...</span><div class='eventsCalendar-list-content'><ul class='eventsCalendar-list'></ul></div></div>"),a.eventsScrollable&&b.wrap.find(".eventsCalendar-list-content").addClass("scrollable"),f(),$(window).resize(function(){f()}),d("current"),g(a.eventsLimit,!1,!1,!1,!1),c(),b.wrap.on("click",".eventsCalendar-day a",function(o){o.preventDefault();var m=b.wrap.attr("data-current-year"),n=b.wrap.attr("data-current-month"),l=$(this).parent().attr("rel");g(!1,m,n,l,"day")}),b.wrap.on("click",".monthTitle",function(n){n.preventDefault();var l=b.wrap.attr("data-current-year"),m=b.wrap.attr("data-current-month");g(a.eventsLimit,l,m,!1,"month")})}),b.wrap.find(".eventsCalendar-list").on("click",".eventTitle",function(n){if(!a.showDescription){n.preventDefault();var o=$(this).parent().find(".eventDesc");if(!o.find("a").size()){var l=$(this).attr("href"),m=$(this).attr("target");o.append('<a href="'+l+'" target="'+m+'" class="bt">'+a.txt_GoToEventUrl+"</a>")}o.is(":visible")?o.slideUp():(a.onlyOneDescription&&b.wrap.find(".eventDesc").slideUp(),o.slideDown())}})},$.fn.eventCalendar.defaults={eventsjson:"js/events.json",eventsLimit:4,monthNames:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],dayNames:["星期日","星期一","星期二","星期三","星期四","星期五","星期六"],dayNamesShort:["周日","周一","周二","周三","周四","周五","周六"],txt_noEvents:"这段时间没有待办事项",txt_SpecificEvents_prev:"",txt_SpecificEvents_after:"待办事项:",txt_next:"下一个",txt_prev:"上一个",txt_NextEvents:"下一个待办事项:",txt_GoToEventUrl:"查看事项",showDayAsWeeks:!0,startWeekOnMonday:!0,showDayNameInCalendar:!0,showDescription:!1,onlyOneDescription:!0,openEventInNewWindow:!1,eventsScrollable:!1,jsonDateFormat:"timestamp",moveSpeed:500,moveOpacity:0.15,jsonData:"",cacheJson:!0};